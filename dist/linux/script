#!/bin/bash

#Error
func_error() {
[ -n $error ] && return 0
echo "
Unexpected Error:
=================

at: $current

Please try again."
exit 1 
}

#Get current architecture
current="1:get architecture"
if [ $(arch) == "x86_64" ] ; then
	arch="64"
elif [ $(arch) == "i386" ] ; then
	arch="32"
else
	error=1
fi
func_error

#Variables
version="0.3.2"
tos="https://popcorntime.io/tos"
downloadlink="https://cdn.popcorntime.io/build/Popcorn-Time-$version-Linux-$arch.tar.gz"

#Disclaimer
clear
echo "
Popcorn Time $version - Linux $arch bits
==================================

Please read our Terms of service:
	$tos

This installer will download and install Popcorn Time in:
	~/.Popcorn-Time
	~/.local/share/applications
"

read -p "If you agree with our ToS, type 'I agree': "
[ "$REPLY" != "I agree" ] && exit 0

#download in temp and install in home
current="2:Downloading archive"
echo "
- Downloading and extracting the archive (FILE_SIZE)..."

wget -O /tmp/popcorntime.tar.gz $downloadlink &> /dev/null || error=1
func_error

#extract archive
current="3:Extract archive"
mkdir -p "$HOME/.Popcorn-Time"
tar -xf "/tmp/popcorntime.tar.gz" -C "$HOME/.Popcorn-Time" --overwrite --preserve-permissions || error=1
func_error

#download icon and install in home
#NEED FIX: a permanent icon uploaded somewhere on our servers.
current="4:Get icon"
wget -O "$HOME/.Popcorn-Time/icon.png" http://i.imgur.com/BhQu7He.png &> /dev/null || error=1
func_error

#create .desktop in home
echo "
- Creating new configuration files..."

current="5:Desktop file"
echo "[Desktop Entry]
Comment=Watch Movies and TV Shows instantly
Name=Popcorn Time
Exec=$HOME/.Popcorn-Time/Popcorn-Time/Popcorn-Time
Icon=$HOME/.Popcorn-Time/icon.png
MimeType=application/x-bittorrent;x-scheme-handler/magnet;
StartupNotify=false
Type=Application" >> "$HOME/.local/share/applications/Popcorn-Time.desktop" &> /dev/null || error=1
func_error

#chmod .desktop
current="6:Chmod files"
chmod +x "$HOME/.Popcorn-Time/Popcorn-Time/Popcorn-Time" &> /dev/null || error=1
chmod +x "$HOME/.local/share/applications/Popcorn-Time.desktop" &> /dev/null || error=1
func_error

#uninstaller
echo "How to uninstall Popcorn Time ?
===============================

1) Main application:
- Delete ~/.Popcorn-Time
- Delete ~/.local/share/applications/Popcorn-Time.desktop

2) Configuration files and databases:
- Delete ~/.config/Popcorn-Time" >> "$HOME/.Popcorn-Time/Uninstall.txt" &> /dev/null

#installation success
echo "

Popcorn Time is now installed in:
	«$HOME/.Popcorn-Time/Popcorn-Time/»
"

#delete this script
rm -rf $0
